<!DOCTYPE html>
<html>
<head>
  <title>好運控V1.12</title>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">

  <link rel="shortcut icon" href="images/fav.png" type="image/x-icon">
  <link rel="apple-touch-icon" href="images/fav.png">
  <link rel="apple-touch-icon" sizes="76x76" href="images/fav.png">
  <link rel="apple-touch-icon" sizes="120x120" href="images/fav.png">
  <link rel="apple-touch-icon" sizes="152x152" href="images/fav.png">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">

  <link rel="stylesheet" href="stylesheets/style.css?t=0033">
</head>

<body class="cursor-pointer" style="background-color: #fff;">
  <div class="flex">
    <section class="flex relative" v-scope="{
      posts: [
        { id: 1, pic: `images/item-1.png`, title: `SUPER STAR` },
        { id: 2, pic: `images/item-2.png`, title: `KONG` },
        { id: 3, pic: `images/item-3.png`, title: `AMULET` },
        { id: 4, pic: `images/item-4.png`, title: `FLOWER` },
        { id: 5, pic: `images/item-5.png`, title: `BUDDHA` },
        { id: 6, pic: `images/item-6.png`, title: `GOLDEN PIG` },
        { id: 7, pic: `images/item-7.png`, title: `MOON BLOCKS` },
      ],
    }" v-on:vue:mounted="tigerHandler($el)">
      <!-- enter -->
      <div id="enterWrap" class="z-[21] absolute tf flex flex-col items-center">
        <div id="enter-item" class="grid *:row-start-1 *:col-start-1 w-[420px]">
          <img src="images/realitem-1.png" class="opacity-0">
          <img src="images/realitem-2.png" class="opacity-0">
          <img src="images/realitem-3.png" class="opacity-0">
        </div>

        <div id="enter-text" class="w-full font-bold text-[70px] flex items-center justify-center gap-[28px] mt-10 opacity-0">
          <span>祇</span>
          <span>願</span>
          <span>開</span>
          <span>始</span>
        </div>
      </div>

      <!-- 這是一條 -->
      <div v-for="p,i in 3" class="tiger relative aspect-[1/4] h-[1920px] overflow-hidden">
        <!-- logo -->
        <img src="images/tiger-logo.svg" class="z-20 absolute tf-x top-[50px]">

        <!-- deco -->
        <img src="images/tiger-kong.svg" class="absolute tf-x top-[50px] max-w-none">

        <ul class="z-10 relative opacity-0 translate-y-full">
          <li v-for="p,i in posts" :data-id="p.id" class="h-[640px] flex flex-col items-center justify-center will-change-transform">
            <div class="px-6 py-12 relative h-[77%]">
              <img :src="p.pic" class="img-contain">
            </div>
            <div class="font-bold text-[34px] border-[5px] border-black rounded-full px-5 pb-px">{{p.title}}</div>
          </li>
        </ul>
      </div>
    </section>
  </div>
</body>

<script src="js/jquery.min.js"></script>
<script src="js/petite-vue.js" defer init></script>
<script src="js/gsap.min.js"></script>
</html>

<script>
  // === 初始化每欄：洗牌 + 複製一份 ul 供無縫輪播 ===
  function tigerHandler(el) {
    $(".tiger", el).each(function (i, el) {
      let $ul = $("ul", el);
      let $li = $("li", el);

      // 隨機排序 li
      const liArray = $li.toArray();
      for (let i = liArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [liArray[i], liArray[j]] = [liArray[j], liArray[i]];
      }
      $ul.empty().append(liArray);

      $ul.clone().appendTo(el);
    });
  }

  // === 依 UID 尾 5 碼選圖（回傳索引 0,1,2）===
  function pickEnterIndexByUID(uid) {
    const MAP = {
      "568EA": 0, // realitem-1.png
      "578EA": 1, // realitem-2.png
      "57CEA": 2  // realitem-3.png
    };
    const tail5 = String(uid || '').slice(-5).toUpperCase();
    return (tail5 in MAP) ? MAP[tail5] : 0; // 找不到預設 0
  }

  // === 收到 UID 後：依映射顯示對應進場圖並播放動畫 ===

  let entered = false; // 是否已經進場

  function handleUID(uid) {
    if (entered) return;   // 已進場就直接忽略
    entered = true;        // 標記已進場

    const idx = pickEnterIndexByUID(uid);
    const $imgs = $('#enter-item img').css('opacity', 0);
    const $img = $imgs.eq(idx);

    const tl = gsap.timeline({ paused: true });
    tl.to($img, { duration: 1.4, opacity: 1 })
      .to("#enter-text", { duration: 1.4, opacity: 1 }, "<0.8")
      .to("#enterWrap", { duration: 1.4, opacity: 0 })
      .to(".tiger ul", {
        duration: 1.6,
        opacity: 1,
        y: 0,
        ease: 'power2.inOut',
        stagger: { each: 0.11 },
      }, "<0.3")
      .play(0);
  }


  $(window).on("load", function () {
    // （不再自動進場，等收到 UID 才觸發）

    // 老虎機效果（維持原樣，但修正亂數範圍 1..7）
    function jslotHandler() {
      let end = Math.floor(Math.random() * 7) + 1; // 1..7

      $(".tiger").each(function (i, item) {
        const h = $("li", item).first().outerHeight(true);
        const total = $("ul", item).first().children().length;
        const totalHeight = $("ul", item).first().outerHeight(true);
        const targetIndex = 1;
        const loop = 6;

        let final = 0;
        $("ul", item).first().children().each(function (i, li) {
          let id = li.dataset.id;
          if (id == end) final = i;
        });

        let baseY = - (final - targetIndex) * h;

        gsap.to($("ul", item), {
          delay: i * 0.2,
          duration: 3,
          y: baseY - loop * totalHeight,
          modifiers: {
            y: (y) => (parseFloat(y) % totalHeight) + "px"
          },
          ease: 'power2.inOut',
        });
      });
    }

    $("body").on("click", function () {
      jslotHandler();
    });
  });
</script>

<script>
  // === WebSocket：連上 rfid_ws_server.js，收到 UID 就觸發 handleUID ===
  (function(){
    function getQueryParam(name) {
      try { return new URL(window.location.href).searchParams.get(name); }
      catch { return null; }
    }

    function resolveWsUrl() {
      const override = getQueryParam('ws');       // 可用 ?ws=ws://host:3000/ws 覆蓋
      if (override) return override;
      if (/^https?:/i.test(location.origin)) {
        return location.origin.replace(/^http/, 'ws') + '/ws';
      }
      return 'ws://localhost:3000/ws';            // file:// 情境的預設
    }

    const wsUrl = resolveWsUrl();
    let ws, retry = 0;

    function connect() {
      try {
        ws = new WebSocket(wsUrl);

        ws.addEventListener('open', () => { retry = 0; });

        ws.addEventListener('message', (ev) => {
          try {
            const data = JSON.parse(ev.data);
            // 兼容 {epcs:[...]}, {epc:""}, {uid:""}
            let uid = null;
            if (Array.isArray(data.epcs) && data.epcs.length) uid = data.epcs[0];
            else if (typeof data.epc === 'string') uid = data.epc;
            else if (typeof data.uid === 'string') uid = data.uid;

            if (uid) handleUID(uid);
          } catch(_) {}
        });

        ws.addEventListener('close', () => {
          retry++;
          const delay = Math.min(30000, 1000 * Math.pow(2, retry - 1));
          setTimeout(connect, delay);
        });

        ws.addEventListener('error', () => { /* 交給 close 重連 */ });
      } catch(_) {
        setTimeout(connect, 2000);
      }
    }

    window.addEventListener('load', connect);
  })();
</script>
